---
phase: 20-recurring-payment-engine
plan: 02
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - packages/server/src/routes/subscriptions.ts
  - packages/server/src/db/subscriptions.ts
autonomous: true

must_haves:
  truths:
    - "Daily billing cron processes all due subscriptions"
    - "User enters 7-day grace period when both chains insufficient"
    - "User with funded wallet during grace period reactivates instantly"
    - "Subscription status API returns grace period info"
  artifacts:
    - path: "packages/server/src/routes/subscriptions.ts"
      provides: "Billing cron endpoint, enhanced status endpoint"
      exports: ["subscriptionsRouter"]
    - path: "packages/server/src/db/subscriptions.ts"
      provides: "Due subscription queries, grace period helpers"
      exports: ["getDueSubscriptions", "getGracePeriodInfo"]
  key_links:
    - from: "packages/server/src/routes/subscriptions.ts"
      to: "packages/server/src/services/subscription-billing.ts"
      via: "processSubscriptionPayment call in cron endpoint"
      pattern: "processSubscriptionPayment"
    - from: "packages/server/src/routes/subscriptions.ts"
      to: "packages/server/src/db/subscriptions.ts"
      via: "getDueSubscriptions for cron processing"
      pattern: "getDueSubscriptions"
---

<objective>
Create billing cron endpoint and grace period management for recurring subscriptions.

Purpose: Enable automated daily billing that processes due subscriptions and handles insufficient funds with 7-day grace period.
Output: Cron endpoint for daily billing, grace period detection, instant reactivation on funding.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-recurring-payment-engine/20-CONTEXT.md

# This plan's dependency
@.planning/phases/20-recurring-payment-engine/20-01-PLAN.md

# Existing code patterns
@packages/server/src/routes/rewards.ts (cron endpoint pattern with CRON_SECRET)
@packages/server/src/routes/subscriptions.ts
@packages/server/src/db/subscriptions.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add grace period helpers to subscriptions database layer</name>
  <files>packages/server/src/db/subscriptions.ts</files>
  <action>
Add to `packages/server/src/db/subscriptions.ts`:

1. GRACE_PERIOD_DAYS constant = 7

2. getDueSubscriptions() -> Subscription[]:
   - Return subscriptions where expires_at <= now (expired or expiring today)
   - These need billing attempt
   - Query: `SELECT * FROM subscriptions WHERE expires_at <= datetime('now') ORDER BY expires_at ASC`

3. getGracePeriodInfo(userId: string) -> { inGracePeriod: boolean; daysRemaining: number; expiredAt: string | null }:
   - Get user's most recent subscription
   - If no subscription: return { inGracePeriod: false, daysRemaining: 0, expiredAt: null }
   - If expires_at > now: return { inGracePeriod: false, daysRemaining: 0, expiredAt: null } (still active)
   - If expires_at <= now:
     - Calculate days since expiration
     - If days since <= GRACE_PERIOD_DAYS: return { inGracePeriod: true, daysRemaining: GRACE_PERIOD_DAYS - daysSince, expiredAt: expires_at }
     - Else: return { inGracePeriod: false, daysRemaining: 0, expiredAt: expires_at } (grace period ended)

4. isInGracePeriod(userId: string) -> boolean:
   - Convenience wrapper around getGracePeriodInfo
   - Returns true if user is in grace period

5. getUserSubscriptionState(userId: string) -> 'active' | 'pending' | 'inactive' | 'never':
   - Get active subscription: if exists and not expired -> 'active'
   - Check grace period: if inGracePeriod -> 'pending'
   - Get any subscription history: if exists -> 'inactive'
   - No history -> 'never'

Export all new functions.
  </action>
  <verify>TypeScript compiles: `cd packages/server && npx tsc --noEmit`</verify>
  <done>Grace period helpers and getDueSubscriptions exist and exported</done>
</task>

<task type="auto">
  <name>Task 2: Add billing cron endpoint and enhance status endpoint</name>
  <files>packages/server/src/routes/subscriptions.ts</files>
  <action>
Update `packages/server/src/routes/subscriptions.ts`:

1. Add imports:
   - processSubscriptionPayment from '../services/subscription-billing.js'
   - getDueSubscriptions, getGracePeriodInfo, getUserSubscriptionState, GRACE_PERIOD_DAYS from '../db/subscriptions.js'

2. POST /api/subscriptions/billing (cron endpoint):
   - Verify CRON_SECRET header (same pattern as rewards.ts /snapshot endpoint)
   - Call getDueSubscriptions() to get all due subscriptions
   - For each subscription:
     a. Call processSubscriptionPayment(subscription.user_id)
     b. Log result (success/failure/insufficient)
   - Return summary: { processed: number, succeeded: number, failed: number, insufficientFunds: number }
   - This runs at midnight UTC via external cron scheduler

3. POST /api/subscriptions/reactivate (instant reactivation):
   - requireAuth middleware
   - Check if user is in grace period via isInGracePeriod
   - If not in grace period: return 400 "Not in grace period"
   - Call processSubscriptionPayment(userId)
   - If success: return { success: true, subscription: {...} }
   - If insufficient: return 402 with balance info
   - If error: return 500

4. Enhance GET /api/subscriptions/status:
   - Add state field using getUserSubscriptionState
   - Add gracePeriod object with daysRemaining, expiredAt (if in grace period)
   - Response shape:
     ```
     {
       active: boolean,
       tier: string | null,
       expires: string | null,
       state: 'active' | 'pending' | 'inactive' | 'never',
       gracePeriod?: { daysRemaining: number, expiredAt: string }
     }
     ```
  </action>
  <verify>TypeScript compiles: `cd packages/server && npx tsc --noEmit`</verify>
  <done>Billing cron endpoint processes due subscriptions, status returns grace period info, reactivate endpoint works</done>
</task>

</tasks>

<verification>
1. TypeScript compiles without errors
2. Cron endpoint requires CRON_SECRET header
3. Status endpoint returns state and gracePeriod info
4. Reactivate endpoint only works during grace period
</verification>

<success_criteria>
- POST /subscriptions/billing processes all due subscriptions with CRON_SECRET auth
- GET /subscriptions/status returns state (active/pending/inactive/never) and grace period info
- POST /subscriptions/reactivate allows instant reactivation during grace period
- Grace period is exactly 7 days after subscription expiration
</success_criteria>

<output>
After completion, create `.planning/phases/20-recurring-payment-engine/20-02-SUMMARY.md`
</output>
