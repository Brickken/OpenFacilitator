---
phase: 20-recurring-payment-engine
plan: 03
type: execute
wave: 2
depends_on: ["20-01"]
files_modified:
  - packages/server/src/routes/subscriptions.ts
  - apps/dashboard/src/lib/api.ts
  - apps/dashboard/src/components/subscriptions/payment-history.tsx
  - apps/dashboard/src/components/subscriptions/status-card.tsx
  - apps/dashboard/src/app/subscriptions/page.tsx
autonomous: true

must_haves:
  truths:
    - "User sees grace period countdown when in pending state"
    - "User can export payment history as CSV"
    - "Payment history shows all attempts including failures"
    - "Reactivate button appears during grace period"
  artifacts:
    - path: "apps/dashboard/src/components/subscriptions/status-card.tsx"
      provides: "Grace period UI with countdown and reactivate button"
      min_lines: 50
    - path: "apps/dashboard/src/components/subscriptions/payment-history.tsx"
      provides: "Enhanced payment history with status column and CSV export"
      min_lines: 80
  key_links:
    - from: "apps/dashboard/src/lib/api.ts"
      to: "/api/subscriptions"
      via: "fetch for payment history and reactivate"
      pattern: "subscriptions/payments|subscriptions/reactivate"
    - from: "apps/dashboard/src/components/subscriptions/status-card.tsx"
      to: "apps/dashboard/src/lib/api.ts"
      via: "reactivateSubscription call"
      pattern: "reactivateSubscription"
---

<objective>
Update frontend to display grace period status, enable CSV export, and show detailed payment history.

Purpose: Give users visibility into their subscription health with grace period countdown and full payment transparency.
Output: Enhanced status card with grace period UI, payment history with status/CSV export, reactivate functionality.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-recurring-payment-engine/20-CONTEXT.md

# Dependencies
@.planning/phases/20-recurring-payment-engine/20-01-PLAN.md

# Existing UI code
@apps/dashboard/src/components/subscriptions/status-card.tsx
@apps/dashboard/src/components/subscriptions/payment-history.tsx
@apps/dashboard/src/app/subscriptions/page.tsx
@apps/dashboard/src/lib/api.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add payment history API endpoint and client methods</name>
  <files>packages/server/src/routes/subscriptions.ts, apps/dashboard/src/lib/api.ts</files>
  <action>
1. Update `packages/server/src/routes/subscriptions.ts`:

Add GET /api/subscriptions/payments endpoint:
- requireAuth middleware
- Query subscription_payments table for user via getSubscriptionPaymentsByUser
- Return payments with: id, date (created_at), amount (formatted), chain, status, txHash, isFallback
- Support query params: limit (default 50), offset (default 0)
- Response: { payments: SubscriptionPaymentResponse[], total: number }

The existing /history endpoint returns subscription records. The new /payments endpoint returns actual payment attempts from subscription_payments table.

2. Update `apps/dashboard/src/lib/api.ts`:

Add types:
```typescript
export interface SubscriptionPaymentAttempt {
  id: string;
  date: string;
  amount: string;
  chain: 'solana' | 'base';
  status: 'success' | 'failed' | 'pending';
  txHash: string | null;
  isFallback: boolean;
}

export interface SubscriptionStatusResponse {
  active: boolean;
  tier: string | null;
  expires: string | null;
  state: 'active' | 'pending' | 'inactive' | 'never';
  gracePeriod?: {
    daysRemaining: number;
    expiredAt: string;
  };
}
```

Add methods:
- getSubscriptionPayments(limit?: number, offset?: number) -> Promise<{ payments: SubscriptionPaymentAttempt[], total: number }>
- reactivateSubscription() -> Promise<{ success: boolean; error?: string; subscription?: { tier: string; expires: string } }>

Update getSubscriptionStatus return type to SubscriptionStatusResponse.
  </action>
  <verify>TypeScript compiles in both packages: `cd packages/server && npx tsc --noEmit && cd ../../apps/dashboard && npx tsc --noEmit`</verify>
  <done>Payment history endpoint returns detailed attempts, API client has new methods and types</done>
</task>

<task type="auto">
  <name>Task 2: Enhance StatusCard with grace period UI and reactivate button</name>
  <files>apps/dashboard/src/components/subscriptions/status-card.tsx</files>
  <action>
Update `apps/dashboard/src/components/subscriptions/status-card.tsx`:

1. Update props interface to accept full SubscriptionStatusResponse (with state and gracePeriod)

2. Add onReactivate prop: () => void
3. Add isReactivating prop: boolean

4. Render based on state:
   - 'active' (green): Show "Active" badge, expiration date
   - 'pending' (amber): Show "Pending - X days to fund wallet" with countdown
     - Display warning icon
     - Show "Fund your wallet to continue service"
     - Show "Reactivate Now" button that calls onReactivate
     - As days decrease, increase urgency (red text at 2 days or less)
   - 'inactive' (red): Show "Inactive" badge
     - "Your subscription has expired"
     - Show "Subscribe" button (existing onSubscribe behavior)
   - 'never' (gray): Show "No subscription"
     - "Start your subscription today"
     - Show "Subscribe" button

5. Grace period countdown format: "X days left to fund wallet"
   - Use amber/yellow color for warning
   - Red color when <= 2 days remaining

Keep existing loading state handling.
  </action>
  <verify>TypeScript compiles: `cd apps/dashboard && npx tsc --noEmit`</verify>
  <done>StatusCard shows state-appropriate UI with grace period countdown and reactivate button</done>
</task>

<task type="auto">
  <name>Task 3: Enhance PaymentHistory with status column and CSV export</name>
  <files>apps/dashboard/src/components/subscriptions/payment-history.tsx, apps/dashboard/src/app/subscriptions/page.tsx</files>
  <action>
1. Update `apps/dashboard/src/components/subscriptions/payment-history.tsx`:

a. Update to accept SubscriptionPaymentAttempt[] (not SubscriptionPayment[])
   - Add status column to table
   - Add isFallback indicator (small "fallback" badge if true)

b. Status badge styling:
   - 'success': green background, checkmark
   - 'failed': red background, X icon
   - 'pending': amber background, clock icon

c. Add CSV export button in CardHeader:
   - Download icon button
   - onClick: generate CSV string from payments array
   - Columns: Date, Amount, Chain, Status, Transaction Hash, Fallback
   - Trigger download via Blob + URL.createObjectURL + temporary anchor click
   - Filename: `subscription-payments-{date}.csv`

d. Show all payment attempts (success and failure) - full transparency per CONTEXT.md

2. Update `apps/dashboard/src/app/subscriptions/page.tsx`:

a. Add query for subscription payments:
   ```typescript
   const { data: paymentsData, isLoading: paymentsLoading } = useQuery({
     queryKey: ['subscriptionPayments'],
     queryFn: () => api.getSubscriptionPayments(),
     enabled: isAuthenticated,
   });
   ```

b. Add reactivate mutation:
   ```typescript
   const reactivateMutation = useMutation({
     mutationFn: () => api.reactivateSubscription(),
     onSuccess: (result) => {
       if (result.success) {
         toast({ title: 'Subscription reactivated!', ... });
         queryClient.invalidateQueries({ queryKey: ['subscription'] });
         queryClient.invalidateQueries({ queryKey: ['subscriptionPayments'] });
       } else {
         toast({ title: 'Reactivation failed', description: result.error, variant: 'destructive' });
       }
     },
   });
   ```

c. Pass new props to StatusCard:
   - onReactivate={() => reactivateMutation.mutate()}
   - isReactivating={reactivateMutation.isPending}

d. Update PaymentHistory to use paymentsData.payments instead of historyData.payments
  </action>
  <verify>TypeScript compiles: `cd apps/dashboard && npx tsc --noEmit`</verify>
  <done>Payment history shows all attempts with status, CSV export works, reactivate wired up</done>
</task>

</tasks>

<verification>
1. TypeScript compiles in both packages
2. Status card shows correct state badge and grace period countdown
3. Payment history table has status column with colored badges
4. CSV export generates valid CSV with all payment columns
5. Reactivate button triggers API call during grace period
</verification>

<success_criteria>
- User in grace period sees countdown: "X days left to fund wallet"
- User can click "Reactivate Now" to attempt immediate payment
- Payment history shows success/failed status with color coding
- CSV export downloads file with date, amount, chain, status, tx hash
- All payment attempts visible (transparency per CONTEXT.md decision)
</success_criteria>

<output>
After completion, create `.planning/phases/20-recurring-payment-engine/20-03-SUMMARY.md`
</output>
